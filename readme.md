
From Edge Probability Map to Vector Parcelsï¼šan effective cropplot post-processing procedure

$$Huaming Gao$$

$$State Key Laboratory of Remote Sensing and Digital Earth$$

$$2025.10.21$$

1. æ¦‚è¿° (Overview)
   
æœ¬é¡¹ç›®æ—¨åœ¨æä¾›ä¸€ä¸ªå®Œæ•´çš„ã€ä»æ·±åº¦å­¦ä¹ æ¨¡å‹è¾“å‡ºçš„è¾¹ç¼˜æ¦‚ç‡å›¾ (Edge Probability Map) åˆ°æœ€ç»ˆç”Ÿäº§çº§çŸ¢é‡åœ°å— (Production-Ready Vector Parcels) çš„å…¨è‡ªåŠ¨åŒ–åå¤„ç†ç®¡çº¿ã€‚

åœ¨å†œç”°é¥æ„Ÿç›‘æµ‹é¢†åŸŸï¼Œæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆå¦‚åŸºäºCNNã€Transformerçš„æ¨¡å‹ï¼‰èƒ½æœ‰æ•ˆè¯†åˆ«åœ°å—è¾¹ç•Œï¼Œä½†å…¶ç›´æ¥è¾“å‡ºçš„æ …æ ¼ç»“æœå¾€å¾€å­˜åœ¨å™ªå£°ã€æ–­è£‚ã€å®½åº¦ä¸ä¸€ã€æ‹“æ‰‘é”™è¯¯ï¼ˆå¦‚æ‚¬æŒ‚çº¿ï¼‰ç­‰é—®é¢˜ï¼Œæ— æ³•ç›´æ¥åº”ç”¨äºä¸‹æ¸¸çš„GISåˆ†æå’Œå†œä¸šç®¡ç†ã€‚æœ¬ç®¡çº¿é€šè¿‡ä¸€ç³»åˆ—åˆ›æ–°æ€§çš„ã€é«˜åº¦ä¼˜åŒ–çš„å›¾åƒå¤„ç†ã€æ‹“æ‰‘åˆ†æå’Œå‡ ä½•è®¡ç®—ï¼Œç³»ç»Ÿæ€§åœ°è§£å†³äº†è¿™äº›æŒ‘æˆ˜ï¼Œå°†ç²—ç³™çš„æ …æ ¼é¢„æµ‹è½¬åŒ–ä¸ºå¹²å‡€ã€æ‹“æ‰‘æ­£ç¡®ã€å‡ ä½•ç²¾ç¡®ä¸”å±æ€§ä¸°å¯Œçš„çŸ¢é‡æ•°æ®ã€‚

2. æ ¸å¿ƒç‰¹æ€§ä¸è´¡çŒ® (Key Features & Contributions)
   
æœ¬ç®¡çº¿å‡ç»“äº†ä¸€ç³»åˆ—æ¢ç´¢ä¸åˆ›æ–°ï¼Œå…¶æ ¸å¿ƒè´¡çŒ®åœ¨äºå¼€å‘äº†ä¸€å¥—é²æ£’ã€é«˜æ•ˆä¸”ç§‘å­¦çš„åå¤„ç†ç®—æ³•ï¼Œä»¥åº”å¯¹çœŸå®ä¸–ç•Œé¥æ„Ÿæ•°æ®çš„å¤æ‚æ€§ï¼š

    âœ¨ åŸºäºå‡ ä½•å½¢æ€çš„è¾¹ç•Œä¸­å¿ƒçº¿æå–:

    æ‘’å¼ƒäº†åœ¨å……æ»¡å™ªå£°çš„åŸå§‹å¼ºåº¦å›¾ä¸Šç›´æ¥æ“ä½œçš„ä¼ ç»Ÿæ€è·¯ã€‚æˆ‘ä»¬åˆ›æ–°æ€§åœ°åˆ©ç”¨è·ç¦»å˜æ¢ (Distance Transform) å°†è¾¹ç•ŒåŒºåŸŸè½¬åŒ–ä¸ºå…·æœ‰æ¸…æ™°å‡ ä½•ç»“æ„çš„â€œå±±è„Šâ€åœ°å½¢å›¾ï¼Œå†ç»“åˆHessiançŸ©é˜µåˆ†æ (Meijering æ»¤æ³¢å™¨) ç²¾ç¡®æå–â€œå±±è„Šçº¿â€ï¼Œä»åŸç†ä¸Šä¿è¯äº†ä¸­å¿ƒçº¿çš„å¹³æ»‘ã€åˆç†æ€§ä¸é²æ£’æ€§ã€‚

    ğŸ§  é«˜é€Ÿæ‹“æ‰‘æ„ŸçŸ¥çš„éª¨æ¶å‰ªæç®—æ³•:
    é’ˆå¯¹éª¨æ¶åŒ–è¿‡ç¨‹ä¸­äº§ç”Ÿçš„â€œæ‚¬æŒ‚çº¿â€ä¼ªå½±ï¼ˆåŒ…æ‹¬å¤šçº§æ‚¬æŒ‚ï¼‰ï¼Œå¼€å‘äº†ä¸€å¥—æœ€ç»ˆç‰ˆçš„å‰ªæç®—æ³• (prune_dangling_lines_fast)ã€‚è¯¥ç®—æ³•åŸºäºæ ‡å‡†çš„äº¤å‰æ•° (Crossing Number) å®šä¹‰ç²¾ç¡®è¯†åˆ«æ‹“æ‰‘æœ«ç«¯ç‚¹ï¼Œå¹¶é€šè¿‡æŸ¥æ‰¾è¡¨(LUT)ä¸å·ç§¯ç›¸ç»“åˆçš„æ–¹å¼å®ç°äº†å®Œå…¨å‘é‡åŒ–ï¼Œå¤„ç†å¤§å°ºå¯¸å½±åƒæ—¶æ€§èƒ½æé«˜ï¼Œèƒ½å½»åº•ã€é«˜æ•ˆåœ°æ¸…é™¤æ‰€æœ‰å±‚çº§çš„æ‚¬æŒ‚çº¿ã€‚

    ğŸ“ å‡ ä½•ä¿çœŸçš„å¯å˜å®½åº¦é‡å»º:

    é‡‡ç”¨ä¸€å¥—**æ‹“æ‰‘æ¸…ç† + åŸºäºè·ç¦»å˜æ¢çš„å‡ ä½•é‡å»º**è§£å†³æ–¹æ¡ˆ (reconstruct_variable_width_from_skeleton)ã€‚åœ¨é€šè¿‡å‰ªæè·å¾—æ‹“æ‰‘å¹²å‡€çš„å•åƒç´ éª¨æ¶åï¼Œåˆ©ç”¨è·ç¦»å˜æ¢çš„ç´¢å¼•åŠŸèƒ½ï¼Œå¹¶è¡Œåœ°ä¸ºéª¨æ¶ä¸Šçš„æ¯ä¸ªç‚¹åŒ¹é…å…¶åœ¨åŸå§‹è¾¹ç•Œæ©ç ä¸­çš„çœŸå®â€œåŠå¾„â€ï¼Œä»è€Œåœ¨æ¢å¤è¾¹ç•Œå®½åº¦çš„åŒæ—¶ï¼Œå®Œç¾ä¿ç•™äº†åŸå§‹è¾¹ç•Œçš„å¤šæ ·æ€§å’Œä¸å‡åŒ€æ€§ï¼Œè§£å†³äº†ä¼ ç»Ÿå›ºå®šå®½åº¦è†¨èƒ€å¯¼è‡´çš„ä¿¡æ¯æŸå¤±é—®é¢˜ã€‚

    ğŸŒ æŠ•å½±æ„ŸçŸ¥çš„çŸ¢é‡å¤„ç†:

    åœ¨çŸ¢é‡å¹³æ»‘ä¸ç®€åŒ–é˜¶æ®µï¼Œä¸¥æ ¼éµå¾ªGISæœ€ä½³å®è·µã€‚æ‰€æœ‰ä¾èµ–äºè·ç¦»çš„è®¡ç®—ï¼ˆå¦‚æ»‘åŠ¨çª—å£å¹³æ»‘ã€Douglas-Peuckerç®€åŒ–ï¼‰éƒ½åœ¨æŠ•å½±åæ ‡ç³» (UTM) ä¸‹è¿›è¡Œï¼Œç¡®ä¿äº†ç›¸å…³å‚æ•°ï¼ˆå¦‚toleranceï¼‰å…·æœ‰æ˜ç¡®çš„ç±³åˆ¶å•ä½ï¼Œé¿å…äº†åœ¨WGS84ç­‰åœ°ç†åæ ‡ç³»ä¸‹ç›´æ¥æ“ä½œå¯¼è‡´çš„å˜å½¢å’Œä¸ä¸€è‡´æ€§ï¼Œä¿è¯äº†å¤„ç†ç»“æœçš„åœ°ç†ç²¾åº¦ã€‚

    ğŸ§© æ¨¡å—åŒ–çš„å®Œæ•´å¤„ç†é“¾:

    å°†æ•´ä¸ªå¤æ‚æµç¨‹æ‹†åˆ†ä¸ºæ …æ ¼é¢„å¤„ç† (thinning.py)ã€çŸ¢é‡åŒ– (thinning.py)ã€çŸ¢é‡åå¤„ç† (smooth.py)ã€è¯­ä¹‰è¿‡æ»¤ (filter_by_cropland.py) ç­‰å¤šä¸ªç‹¬ç«‹ã€å¯é…ç½®çš„Pythonè„šæœ¬ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯é‡ç”¨æ€§å’Œæµç¨‹çš„çµæ´»æ€§ã€‚ç”¨æˆ·å¯æ ¹æ®éœ€è¦é€‰æ‹©æ€§åœ°æ‰§è¡Œæˆ–è°ƒæ•´å„ä¸ªé˜¶æ®µã€‚

3. å¤„ç†ç®¡çº¿è¯¦è§£ (The Processing Pipeline)
   
    æ•´ä¸ªå·¥ä½œæµä»ä¸€ä¸ªè¾“å…¥çš„è¾¹ç¼˜æ¦‚ç‡å›¾GeoTIFFå¼€å§‹ï¼Œåˆ°æœ€ç»ˆè¾“å‡ºä¸€ä¸ªå¹²å‡€çš„å†œç”°åœ°å—Shapefileç»“æŸï¼Œå…±åˆ†ä¸ºå››ä¸ªä¸»è¦é˜¶æ®µï¼š

    é˜¶æ®µä¸€ï¼šæ …æ ¼è¾¹ç•Œç²¾ç‚¼ä¸æ‹“æ‰‘æ¸…ç†

    è„šæœ¬: thinning.py
    è¾“å…¥: åŸå§‹è¾¹ç¼˜æ¦‚ç‡å›¾GeoTIFF (å‡è®¾è¾¹ç•Œä¸ºæš—å€¼)ã€‚

    æ ¸å¿ƒæ­¥éª¤:

    - æ„å»ºè·ç¦»å›¾: åè½¬æ¦‚ç‡å›¾ -> å®šä¹‰â€œåœ°å—å†…éƒ¨â€ -> å½¢æ€å­¦æ¸…ç† -> è·ç¦»å˜æ¢ (distance_transform_edt)ã€‚
    æå–ä¸­å¿ƒçº¿: å¯¹è·ç¦»å›¾åº”ç”¨ Hessian (Meijering) æ»¤æ³¢å™¨ -> Otsuè‡ªåŠ¨é˜ˆå€¼ã€‚

    - å¤„ç†è¾¹ç¼˜æ•ˆåº”: æ·»åŠ å¤–å›´è¾¹ç•Œæ¡†æ¶ (add_thick_border_frame)ã€‚

    - é¢„å¤„ç†ä¸éª¨æ¶åŒ–: (å¯é€‰) æå–æœ€å¤§è¿é€šåŸŸ -> skeletonizeã€‚

    - æ‹“æ‰‘å‰ªæ: åº”ç”¨é«˜é€Ÿå‘é‡åŒ–å‰ªæ (prune_dangling_lines_fast)ã€‚

    - å‡ ä½•é‡å»º: åº”ç”¨å¯å˜å®½åº¦é‡å»º (reconstruct_variable_width_from_skeleton)ã€‚

    - å®ä¾‹åˆ†å‰²ä¸è¿‡æ»¤: label + remove_small_objectsã€‚

    - è¾“å‡º: ä¸´æ—¶çš„ã€å¸¦åœ°ç†ä¿¡æ¯çš„ã€å·²æ¸…ç†çš„æ …æ ¼å®ä¾‹å›¾ (GeoTIFF)ã€‚

    é˜¶æ®µäºŒï¼šçŸ¢é‡åŒ– (Vectorization)

    è„šæœ¬: thinning.py (å†…éƒ¨è°ƒç”¨line2shpå‡½æ•°)

    è¾“å…¥: é˜¶æ®µä¸€è¾“å‡ºçš„æ …æ ¼å®ä¾‹å›¾ã€‚

    æ ¸å¿ƒæ­¥éª¤: è°ƒç”¨ gdal.Polygonize() å°†æ …æ ¼è½¬æ¢ä¸ºçŸ¢é‡ã€‚

    è¾“å‡º: åŸå§‹çš„ã€å¸¦æœ‰é”¯é½¿è¾¹ç•Œçš„çŸ¢é‡åœ°å—æ–‡ä»¶ (Shapefile)ã€‚

    é˜¶æ®µä¸‰ï¼šçŸ¢é‡åå¤„ç† (Vector Post-Processing)

    è„šæœ¬: smooth.py

    è¾“å…¥: é˜¶æ®µäºŒè¾“å‡ºçš„åŸå§‹çŸ¢é‡æ–‡ä»¶ (WGS84)ã€‚

    æ ¸å¿ƒæ­¥éª¤:

    - è¾¹ç•Œå¹³æ»‘: åº”ç”¨åŸºäºæ»‘åŠ¨çª—å£çš„æ–¹å‘ä¿æŒå¹³æ»‘ (smooth_parcels_by_window)ã€‚
  
    - é¡¶ç‚¹ç®€åŒ–: 
        æŠ•å½±: WGS84 -> UTM (_reproject_layer)ã€‚
        ç®€åŒ–: åœ¨UTMä¸‹åº”ç”¨Douglas-Peucker (geom.Simplify)ï¼Œå®¹å·®ä»¥ç±³ä¸ºå•ä½ã€‚
        åå‘æŠ•å½±: UTM -> WGS84 (_reproject_layer)ã€‚
    - è¾“å‡º: è¾¹ç•Œå¹³æ»‘ã€é¡¶ç‚¹æ•°é‡åˆç†çš„ä¼˜åŒ–çŸ¢é‡æ–‡ä»¶ (Shapefile, WGS84)ã€‚
  
    é˜¶æ®µå››ï¼šè¯­ä¹‰è¿‡æ»¤ (Semantic Filtering)

    è„šæœ¬: filter_by_cropland.py

    è¾“å…¥: é˜¶æ®µä¸‰è¾“å‡ºçš„ä¼˜åŒ–çŸ¢é‡æ–‡ä»¶å’Œè€•åœ°èŒƒå›´æ …æ ¼æ©è†œ (Mask TIF)ã€‚

    æ ¸å¿ƒæ­¥éª¤: è®¡ç®—æ¯ä¸ªåœ°å—ä¸è€•åœ°æ©è†œçš„é‡å ç‡ (filter_parcels_by_mask_gdal)ï¼Œå¹¶æ ¹æ®é˜ˆå€¼è¿›è¡Œè¿‡æ»¤ã€‚

    è¾“å‡º: æœ€ç»ˆçš„ã€é«˜è´¨é‡çš„å†œç”°åœ°å—çŸ¢é‡æˆæœ (Shapefile)ã€‚
    
4. å¦‚ä½•ä½¿ç”¨ (How to Use)
4.1 ç¯å¢ƒé…ç½®
å¼ºçƒˆå»ºè®®ä½¿ç”¨Condaåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„Pythonç¯å¢ƒï¼Œå¹¶ä»conda-forgeæ¸ é“å®‰è£…æ‰€æœ‰ä¾èµ–ï¼Œä»¥ç¡®ä¿åº“ä¹‹é—´çš„å…¼å®¹æ€§ã€‚
# åˆ›å»ºæ–°ç¯å¢ƒ (Python 3.8æˆ–æ›´é«˜ç‰ˆæœ¬)
conda create -n geo_env python=3.9

# æ¿€æ´»ç¯å¢ƒ
conda activate geo_env

# ä» conda-forge å®‰è£…æ‰€æœ‰å¿…éœ€çš„åº“
conda install -c conda-forge gdal scikit-image scipy matplotlib opencv numpy pandas




4.2 ä¾èµ–åº“
numpy
gdal (osgeo)
opencv-python (cv2)
scikit-image (skimage)
scipy
matplotlib (ç”¨äºå¯è§†åŒ–)
pandas (ç”¨äºskan, å¦‚æœä½¿ç”¨skanå‰ªæ)
4.3 è¿è¡Œæµç¨‹
æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹Pythonè„šæœ¬ï¼Œå¹¶æ ¹æ®æ‚¨çš„æ–‡ä»¶è·¯å¾„å’Œå‚æ•°éœ€æ±‚ä¿®æ”¹æ¯ä¸ªè„šæœ¬æœ«å°¾çš„ if __name__ == '__main__': éƒ¨åˆ†ã€‚
thinning.py:
é…ç½®: è®¾ç½®è¾“å…¥è¾¹ç¼˜æ¦‚ç‡å›¾ (in_raster) å’Œé˜¶æ®µäºŒè¾“å‡ºçš„åŸå§‹çŸ¢é‡è·¯å¾„ (shapefile_filename)ã€‚æ ¹æ®éœ€è¦è°ƒæ•´å†…éƒ¨å‚æ•°ï¼ˆå¦‚å®šä¹‰å†…éƒ¨åŒºåŸŸçš„é˜ˆå€¼ã€Hessianæ»¤æ³¢å™¨çš„sigmasç­‰ï¼‰ã€‚
è¿è¡Œ: python thinning.py
smooth.py:
é…ç½®: è®¾ç½®è¾“å…¥Shapefile (input_shpï¼ŒæŒ‡å‘ä¸Šä¸€æ­¥çš„è¾“å‡º)ï¼Œæœ€ç»ˆç®€åŒ–åçš„è¾“å‡ºShapefile (output_shp_simple)ï¼Œä»¥åŠä¸­é—´å¹³æ»‘ç»“æœçš„è·¯å¾„ (output_shp)ã€‚
é‡è¦: è®¾ç½®æ­£ç¡®çš„ TARGET_UTM_EPSG_CODEã€‚
è°ƒæ•´: window_size, strength (å¹³æ»‘å‚æ•°)ï¼Œtolerance_in_meters (ç®€åŒ–å‚æ•°)ã€‚
è¿è¡Œ: python smooth.py
filter_by_cropland.py:
é…ç½®: è®¾ç½®è¾“å…¥Shapefile (parcel_shpï¼ŒæŒ‡å‘ä¸Šä¸€æ­¥çš„è¾“å‡º)ï¼Œè€•åœ°æ©è†œæ–‡ä»¶ (mask_tif)ï¼Œä»¥åŠæœ€ç»ˆè¿‡æ»¤ç»“æœçš„è¾“å‡ºè·¯å¾„ (output_shp)ã€‚
è°ƒæ•´: threshold (é‡å ç‡é˜ˆå€¼ï¼Œ0åˆ°1ä¹‹é—´)ã€‚
è¿è¡Œ: python filter_by_cropland.py
5. å¼•ç”¨ (Citation)
å¦‚æœæœ¬é¡¹ç›®å¯¹æ‚¨çš„ç ”ç©¶æœ‰æ‰€å¸®åŠ©ï¼Œè¯·è€ƒè™‘å¼•ç”¨ä»¥ä¸‹å…³é”®æŠ€æœ¯æˆ–åº“ï¼š
æ ¸å¿ƒç®—æ³•æ€æƒ³: Gao, H. (2025). å†œç”°åœ°å—æ™ºèƒ½æå–ä¸ç²¾å¤„ç†ç®¡çº¿ [Algorithm Documentation]. State Key Laboratory of Remote Sensing and Digital Earth, Aerospace Information Research Institute, Chinese Academy of Sciences.
GDAL/OGR: GDAL/OGR Contributors. (2023). GDAL/OGR Geospatial Data Abstraction software Library. Open Source Geospatial Foundation. https://gdal.org
Scikit-image: Van der Walt, S., SchÃ¶nberger, J. L., Nunez-Iglesias, J., Boulogne, F., Warner, J. D., Yager, N., ... & Yu, T. (2014). scikit-image: image processing in Python. PeerJ, 2, e453.
SciPy: Virtanen, P., Gommers, R., Oliphant, T. E., Haberland, M., Reddy, T., Cournapeau, D., ... & SciPy 1.0 Contributors. (2020). SciPy 1.0: fundamental algorithms for scientific computing in Python. Nature methods, 17(3), 261-272.
OpenCV: Bradski, G. (2000). The OpenCV Library. Dr. Dobb's Journal of Software Tools.
NumPy: Harris, C. R., Millman, K. J., van der Walt, S. J., Gommers, R., Virtanen, P., Cournapeau, D., ... & Oliphant, T. E. (2020). Array programming with NumPy. Nature, 585(7825), 357-362.
å¯å‘æ€§å·¥ä½œ: æœ¬å·¥ä½œæµçš„éƒ¨åˆ†åå¤„ç†æ€æƒ³ï¼ˆå¦‚å¤šå±‚æ¬¡å¤„ç†è¾¹ç•Œå¼ºåº¦ï¼‰å—åˆ°äº†ä»¥ä¸‹ç ”ç©¶çš„å¯å‘ï¼š
Wu, W., Chen, T., Yang, H., He, Z., Chen, Y., & Wu, N. (2023). Multilevel segmentation algorithm for agricultural parcel extraction from a semantic boundary. International Journal of Remote Sensing, 44(3), 1045-1068. DOI: 10.1080/01431161.2023.2174386
6. æœªæ¥å·¥ä½œ (Future Work)
å¹¶è¡ŒåŒ–å¤„ç†: å°†åˆ†å—å¤„ç†ï¼ˆTilingï¼‰ç­–ç•¥ä¸multiprocessingåº“ç»“åˆï¼Œä»¥åœ¨å¤šæ ¸CPUä¸Šå¹¶è¡Œå¤„ç†å¤§èŒƒå›´å½±åƒã€‚
å‚æ•°è‡ªåŠ¨åŒ–: æ¢ç´¢åŸºäºå›¾åƒç‰¹å¾è‡ªåŠ¨ç¡®å®šå¹³æ»‘ã€ç®€åŒ–å’Œè¿‡æ»¤å‚æ•°æœ€ä¼˜å€¼çš„æ–¹æ³•ã€‚
æ‹“æ‰‘ä¿®å¤: åœ¨çŸ¢é‡åŒ–åï¼Œå¢åŠ æ›´é«˜çº§çš„æ‹“æ‰‘æ£€æŸ¥ä¸ä¿®å¤æ­¥éª¤ï¼ˆå¦‚ä½¿ç”¨GEOSä¿®å¤å¾®å°çš„å‡ ä½•é”™è¯¯ï¼‰ã€‚
ç”¨æˆ·ç•Œé¢: å¼€å‘ä¸€ä¸ªç®€å•çš„å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼‰ï¼Œæ–¹ä¾¿éç¼–ç¨‹äººå‘˜ä½¿ç”¨ã€‚
